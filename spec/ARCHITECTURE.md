# Multi-Workflow System Architecture (v2 - Current State)

## 1. Purpose and Status

- **Goal**: Internal web app for consulting project estimation and contract generation.
- **Status**:
  - **Estimates Workflow**: largely implemented (6 stages, WBS, Quote).
  - **Contracts Workflow**: Planned / Placeholder.
  - **Copilot**: Implemented via Model Context Protocol (MCP).

## 2. Tech Stack

### Frontend
- **Framework**: Next.js 15 (App Router) + React.
- **UI System**: Tailwind CSS + Shadcn/UI (Radix primitives).
- **State**: Server Components + Server Actions.

### Backend
- **Runtime**: Next.js Server Environment (Node.js).
- **Database**: PostgreSQL (via Neon/Local).
- **ORM**: Prisma.
- **AI/LLM**: OpenAI (GPT-4o) accessed via MCP Layer.

### Architecture: The MCP Layer
The system uses the **Model Context Protocol (MCP)** pattern to standardize how the Copilot (LLM) reads state and executes actions.
- **Server**: `lib/mcp/server.ts` (`McpLLMServer`)
- **Protocol**: Defines typed `McpToolName`s (e.g., `estimates.generateWbsItems`) and request/response schemas.
- **Flow**: UI -> API (`/api/copilot`) -> `McpLLMServer` -> Domain Service -> LLM.

## 3. Application Structure

### Directory Layout
- `app/`
  - `estimates/`: Project list and detail views.
  - `contracts/`: Placeholder for contracts workflow.
  - `api/`:
    - `copilot/`: Main chat endpoint.
    - `artifacts/`: File upload handling.
- `lib/`
  - `mcp/`: MCP server implementation, tool definitions, and error handling.
  - `copilot/`: LLM prompts, context builders, and prompt engineering logic.
  - `services/`: Domain logic (EstimatesService, ContractsService).
  - `zod/`: Shared validation schemas.
- `prisma/`: Database schema and migrations.

## 4. Domain Models

### 4.1 Estimates Domain (Implemented)

The estimation process follows a strict 6-stage pipeline.

**Core Entities:**
- **Project**: The root aggregate. Tracks `currentStage`.
  - Stages: `ARTIFACTS`, `BUSINESS_CASE`, `REQUIREMENTS`, `SOLUTION`, `EFFORT`, `QUOTE`.
- **Artifact**: Uploaded files or raw text used as context for the LLM.
- **Stage Drafts** (One-to-one with Project):
  - `BusinessCase`
  - `Requirements`
  - `SolutionArchitecture`
  - `Quote`
- **WBSItem**: Individual line items for the Effort Estimate stage.
  - Links to `Role` (rate card).
- **Role**: Global rate card definitions (e.g., "Senior Engineer", "PM").

### 4.2 Contracts Domain (Planned)

*Note: These models are defined in requirements but not yet present in `schema.prisma`.*

- **PolicyRule**: Rules for guiding contract generation (e.g., "Payment terms must be Net 30").
- **Agreement**: Represents an MSA or SOW.
- **AgreementVersion**: Tracks content history.
- **Proposal**: Specific change requests (before/after text) generated by the Review Agent.

## 5. Logical Data Flow

### Estimates Flow
1.  **Ingest**: User uploads Artifacts.
2.  **Generate**: User requests Copilot to "Draft Business Case".
    -   MCP Tool `estimates.generateBusinessCaseFromArtifacts` is called.
    -   LLM reads Artifacts, generates text.
3.  **Refine**: User edits the draft in the UI.
4.  **Approve**: User clicks "Approve", advancing the Project Stage.
5.  **Chain**: Subsequent stages (Requirements, Solution) use prior approved stages as context.

### Copilot / MCP Execution
All LLM interactions go through `lib/mcp/server.ts`.
1.  **Chat Request**: User asks "Update WBS hours".
2.  **Routing**: MCP Server identifies tool `estimates.generateWbsItems` or `chat`.
3.  **Context**: `buildArtifactContext` gathers relevant DB data (Artifacts, previous stages).
4.  **Execution**: `callProviderLLM` invokes the model with specific System Prompts from `lib/copilot/prompts/`.

## 6. Roadmap

1.  **Contracts Implementation**:
    -   Add `Agreement` and `Policy` models to Prisma.
    -   Implement `ContractsService`.
    -   Add MCP tools for `contracts.generate` and `contracts.review`.
2.  **Cross-Workflow Integration**:
    -   Link `Agreement` to `Project`.
    -   Allow Copilot to read `WBSItem`s when drafting an SOW.

